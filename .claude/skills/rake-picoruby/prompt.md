---
model: claude-haiku-4-5-20251001
disable-model-invocation: true
context: fork
agent: general-purpose
---

# PicoRuby Rake Operations Subagent

You are delegated to run PicoRuby build/flash/monitor operations via rake.

## Task

Run the specified rake tasks in the `picoruby/` directory and extract key information from verbose output.

## Command Format

```bash
cd picoruby && APP=<app_name> rake <task1> <task2> ...
```

**Multiple tasks can be chained by space-separated names. Tasks execute sequentially.**

## Available Tasks

- `build`: Compile .rb → .mrb, copy to components/, run idf.py build
- `flash`: Flash firmware to ATOM Matrix ESP32
- `monitor`: Monitor serial output from device
- `check_env`: Verify ESP-IDF environment
- `cleanbuild`: Full clean rebuild
- `buildall`: Setup + build

## Common Task Chains

- `rake build flash` - Build and flash (typical workflow)
- `rake build flash monitor` - Build, flash, and monitor (full cycle)
- `rake cleanbuild flash` - Clean rebuild and flash
- `rake cleanbuild flash monitor` - Clean rebuild, flash, and monitor

## Serial Port Release Before Flash

**ALWAYS run this before any `flash` task** to prevent "port busy" errors.

Chrome Web Serial may hold the port open. Release it first:

```bash
# macOS: release via AppleScript to Chrome
osascript -e 'tell application "Google Chrome" to execute active tab of first window javascript "if(typeof serialDisconnect === \"function\") { serialDisconnect(); } navigator.serial.getPorts().then(async ports => { for(const p of ports) { try { if(p.readable) { const r = p.readable.getReader(); r.cancel(); r.releaseLock(); } if(p.writable) { p.writable.getWriter().releaseLock(); } await p.close(); } catch(e) {} } console.log(\"[PortRelease] Done\"); });"' 2>/dev/null

sleep 2

# Verify port is free
PORT=$(ls /dev/cu.usbserial-* 2>/dev/null | head -1)
if [ -n "$PORT" ]; then
  HOLDER=$(lsof "$PORT" 2>/dev/null | awk 'NR>1 {print $1, $2}' | head -1)
  if [ -n "$HOLDER" ]; then
    echo "WARNING: Port $PORT still busy: $HOLDER"
    echo "Manually disconnect Web Serial from the visualizer before flashing."
    exit 1
  fi
fi
echo "Port released OK"
```

## Build + Flash Execution (60-120 seconds)

When running `build flash`:

1. **Execution time**: 60-120 seconds (monitor every 10 seconds)
2. **Abnormal exit detection**: Check for R2P2 shell prompt `$>`
   - Prompt `$>` indicates app.mrb crashed and R2P2 fell back to interactive shell
   - If detected: **STOP immediately and report as FAILURE**
3. **Expected output**: `Wrote ... bytes`, `Hash of data verified`, `completed successfully`

Implementation (pseudo-code):
```bash
# Run build+flash with 10-second monitoring checks
cd picoruby && APP=<app_name> rake build flash 2>&1 &
PROC_PID=$!
ELAPSED=0

while kill -0 $PROC_PID 2>/dev/null && [ $ELAPSED -lt 120 ]; do
  sleep 10
  ELAPSED=$((ELAPSED + 10))
  # Check if $> prompt appeared in output
  if grep -q '^\$>' build_flash.log; then
    kill $PROC_PID 2>/dev/null
    Report: "FAILURE: R2P2 shell prompt detected ($>), app.mrb crashed"
    exit 1
  fi
done
```

## Monitor Auto-Execution

`monitor` is an auto-running server started by app.mrb. When running `monitor` task:

1. **Capture logs for 10 seconds** to allow app.mrb startup and initial logging
2. **Detect R2P2 shell prompt** (`$>`):
   - If detected in first few lines → app.mrb failed to start (abnormal exit)
   - If detected after logs → app.mrb crashed during execution (abnormal exit)
3. **Expected output**: UART LED frames (`<L:NNN,B:NNN,M:NNN,H:NNN>`) or firmware state messages

Implementation:
```bash
cd picoruby && APP=<app_name> (sleep 10; pkill -P $$ -f "idf.py monitor") & rake monitor 2>&1 | head -50
```

## Output Filtering

Run the full command but extract ONLY these key lines:

1. **Errors** (report all):
   - Lines containing `Error:`, `error:`, `FAILED`, `abort`
   - Full stack traces for compilation/build failures
   - Interactive shell prompt appearance: `$>` (indicates crash)

2. **Warnings** (report all):
   - Lines containing `Warning:`, `warning:`, `CRITICAL`

3. **Build Progress** (report summary):
   - `Compiling: <file>` - report file names being compiled
   - `Created app.mrb from <app_name>.mrb` - report MRB creation
   - `Removed:` lines - suppress (noise)
   - `Copied src_components contents` - report once

4. **Flash Progress** (report summary):
   - `Wrote ... bytes`, `Hash of data verified` - report important flash steps
   - ESP-IDF idf.py flash output - extract key completion lines

5. **Monitor Output** (capture all):
   - LED frame output: `<L:NNN,B:NNN,M:NNN,H:NNN>`
   - State messages from app.mrb
   - Any log messages generated by running firmware
   - **CRITICAL: Detect R2P2 shell prompt** `$>` (abnormal exit indicator)

6. **Final Status** (report always):
   - `completed successfully` or `Build completed successfully`
   - `Monitor terminated` (if timeout reached normally)
   - `FAILURE: R2P2 shell prompt detected` (abnormal exit - app.mrb crashed)
   - Any abort/error exit status

## Implementation

For chained build+flash (with 10-second monitoring checks):
```bash
cd picoruby && APP=<app_name> rake build flash 2>&1 | tee build_flash.log &
PROC_PID=$!
ELAPSED=0

while kill -0 $PROC_PID 2>/dev/null && [ $ELAPSED -lt 120 ]; do
  sleep 10
  ELAPSED=$((ELAPSED + 10))
  if grep -q '^\$>' build_flash.log 2>/dev/null; then
    kill $PROC_PID 2>/dev/null
    echo "FAILURE: R2P2 shell prompt detected, app.mrb crashed"
    exit 1
  fi
done

cat build_flash.log | grep -E '(Error:|error:|Warning:|warning:|Compiling:|Created app|Wrote|Hash of data verified|completed successfully|FAILED|abort|\$>)' | head -100
```

For build+flash+monitor (with 10-second monitor capture):
```bash
cd picoruby && APP=<app_name> rake build flash 2>&1 | grep -E '(Error:|error:|Warning:|warning:|Compiling:|Created app|Wrote|Hash of data verified|completed successfully|FAILED|abort)' | head -100

# Monitor: capture 10 seconds, detect $> prompt
(sleep 10; pkill -P $$ -f "idf.py monitor") & rake monitor 2>&1 | head -50 | tee monitor.log

if grep -q '^\$>' monitor.log 2>/dev/null; then
  echo "FAILURE: R2P2 shell prompt detected in monitor output, app.mrb crashed"
  exit 1
fi

cat monitor.log | grep -E '(Error:|error:|L:.*B:.*M:.*H:|\$>)' | head -100
```

## Report Format

After command completion, summarize by task:

```
=== Rake Tasks: <task1> <task2> ... (APP=<app_name>) ===

[Task 1: build]
[Key extracted lines]
Status: SUCCESS / FAILURE

[Task 2: flash]
[Key extracted lines]
Status: SUCCESS / FAILURE

[Task 3: monitor (if included)]
[Monitor logs for ~10 seconds]
Status: SUCCESS / FAILURE (R2P2 shell prompt detected - app.mrb crashed)
```

If any task fails, stop and report the failure reason immediately. If R2P2 shell prompt `$>` is detected, report as **ABNORMAL EXIT - app.mrb initialization failed**.
